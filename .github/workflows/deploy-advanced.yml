name: Advanced Deploy to Surge.sh

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ” Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run linting (if available)
      run: npm run lint --if-present
      
    - name: ğŸ—ï¸ Build project
      run: npm run build
      
    - name: ğŸ“‚ List build artifacts
      run: |
        echo "Build completed successfully!"
        ls -la dist/
        du -sh dist/
        
    - name: â¬†ï¸ Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-files
        path: dist/
        retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://difficult-bell.surge.sh
    
    steps:
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-files
        path: dist/
        
    - name: ğŸ“¦ Install Surge CLI
      run: npm install -g surge
      
    - name: ğŸš€ Deploy to Surge.sh
      run: |
        echo "Deploying to production..."
        surge dist/ difficult-bell.surge.sh --token $SURGE_TOKEN
      env:
        SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        
    - name: âœ… Deployment success
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Site URL: https://difficult-bell.surge.sh"
        
  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    environment:
      name: staging
      url: https://staging-difficult-bell.surge.sh
    
    steps:
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-files
        path: dist/
        
    - name: ğŸ“¦ Install Surge CLI
      run: npm install -g surge
      
    - name: ğŸš€ Deploy to Staging
      run: |
        echo "Deploying to staging..."
        surge dist/ staging-difficult-bell.surge.sh --token $SURGE_TOKEN
      env:
        SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        
    - name: âœ… Staging deployment success
      run: |
        echo "ğŸ‰ Staging deployment completed successfully!"
        echo "ğŸŒ Staging URL: https://staging-difficult-bell.surge.sh"
